<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de CV Profesional | CV Studio33</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Open+Sans:wght@400;600&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0f172a',
                        secondary: '#3b82f6',
                        accent: '#6366f1',
                        dark: '#020617',
                        paper: '#ffffff',
                        /* Colores Default (Se sobrescriben en el CSS para el diseño Martin) */
                        cvDark: '#1e293b',   
                        cvTitle: '#1e3a8a',  
                        cvAccent: '#2563eb', 
                        cvText: '#334155',   
                        cvLight: '#64748b',  
                    },
                    fontFamily: {
                        sans: ['Open Sans', 'sans-serif'],
                        heading: ['Montserrat', 'sans-serif'],
                        cv: ['Roboto', 'sans-serif'],
                    },
                    screens: {
                        'print': {'raw': 'print'},
                    }
                }
            }
        }
    </script>

    <style>
        /* =========================================
           ESTILOS BASE DEL APLICATIVO (NO TOCAR)
           ========================================= */
        body {
            background-color: #0f172a;
            color: white;
            font-family: 'Open Sans', sans-serif;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }

        .editor-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            height: calc(100vh - 80px); 
            overflow-y: auto;
        }

        /* Hoja A4 Base */
        .a4-page {
            width: 210mm;
            height: 296mm; 
            padding: 0;
            background: white;
            color: #333;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            margin: 0 auto 20px auto; /* Margen inferior para separar hojas */
            position: relative;
            overflow: hidden; 
            transform-origin: top center;
            transition: transform 0.3s ease;
        }

        /* Inputs del Editor */
        .cv-input, .cv-select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        .cv-input:focus, .cv-select:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        .cv-select option { background-color: #1e293b; color: white; }

        .config-slider {
            -webkit-appearance: none; width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; outline: none;
        }
        .config-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: #3b82f6; cursor: pointer; transition: background .15s ease-in-out;
        }
        .config-slider::-webkit-slider-thumb:hover { background: #60a5fa; }

        .cv-label {
            display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; margin-bottom: 4px; font-weight: 600; margin-top: 10px;
        }

        .accordion-header { cursor: pointer; transition: background 0.3s; }
        .accordion-header:hover { background: rgba(255,255,255,0.05); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; }
        .accordion-content.active { max-height: 5000px; }

        /* Drag & Drop Styles */
        .sortable-ghost { opacity: 0.4; background-color: #f0f9ff; border: 2px dashed #31548f; }
        .draggable-item { cursor: grab; position: relative; transition: background 0.2s; }
        .draggable-item:hover { background-color: rgba(49, 84, 143, 0.05); }
        .draggable-item:active { cursor: grabbing; }
        .draggable-item::before {
            content: '⋮⋮'; position: absolute; left: -15px; top: 0; color: #ccc; font-size: 14px; opacity: 0; transition: opacity 0.2s; cursor: grab;
        }
        .draggable-item:hover::before { opacity: 1; }

        .ai-loading { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .warning-text { font-size: 0.65rem; color: #fbbf24; margin-top: 2px; font-style: italic; }

        .mobile-preview-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; overflow-y: auto; display: none;
        }
        .mobile-preview-modal.active { display: block; }

        /* =========================================
           ESTILOS ESPECÍFICOS: MARTIN JANSSEN
           ========================================= */
        
        .martin-cv-page {
            font-family: 'Arial Narrow', Arial, sans-serif !important;
            display: flex;
            flex-direction: column;
            background-color: white;
        }

        /* Variables de color Martin Janssen */
        :root {
            --mj-blue: #31548f;
            --mj-text: #000;
            --mj-grey: #444;
            --mj-light-grey: #666;
        }

        /* Header Superior */
        .mj-top-header {
            background-color: var(--mj-blue);
            height: 32px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex-shrink: 0;
        }
        .mj-top-header span {
            color: white;
            font-weight: bold;
            font-size: 20px;
            padding-right: 40px;
            font-family: 'Arial Narrow', sans-serif;
        }

        /* Contenido Principal */
        .mj-main-content {
            padding: 40px 50px;
            flex-grow: 1;
        }

        /* Nombre y Título */
        .mj-fullname {
            color: var(--mj-blue);
            font-size: 50px;
            margin: 0;
            font-family: 'Arial Narrow', sans-serif;
            font-weight: bold;
            letter-spacing: -1px;
            line-height: 1;
            text-transform: uppercase;
        }
        .mj-title {
            color: var(--mj-light-grey);
            font-size: 18px;
            margin: 5px 0 30px 0;
            text-transform: uppercase;
            font-weight: normal;
        }

        /* Sección Datos Personales (Grid/Flex) */
        .mj-personal-info-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
        }
        .mj-info-left { width: 65%; }
        .mj-photo-box {
            width: 160px; height: 195px; background-color: #e0e0e0; border: 1px solid #ddd;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }

        /* Tablas y Textos */
        .mj-table { width: 100%; border-collapse: collapse; }
        .mj-table td { padding: 2px 0; vertical-align: top; font-size: 13px; }
        .mj-label { width: 140px; color: #333; }
        .mj-value { font-weight: bold; color: #000; }

        /* Títulos de Sección */
        .mj-section-header {
            color: var(--mj-blue);
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 12px;
            text-transform: uppercase;
            border-bottom: none; 
        }

        /* Ajustes de Texto Generales */
        .mj-body-text {
            font-family: 'Arial Narrow', sans-serif !important;
            font-size: 12px !important;
            color: #444 !important;
            line-height: 1.4 !important;
        }

        /* Experience/Education Styles */
        .mj-job-title {
            font-family: 'Arial Narrow', sans-serif !important;
            font-weight: bold !important;
            font-size: 13px !important;
            color: #000 !important;
            margin-bottom: 2px !important;
        }
        .mj-job-meta {
            color: #000 !important;
            font-size: 12px !important;
            font-weight: bold !important;
        }

        /* DISEÑO MEJORADO: SKILLS (Clean Cards) */
        .mj-skills-modern-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .mj-skill-card {
            background: white;
            border: 1px solid #e5e7eb; /* Gris muy suave */
            border-left: 3px solid var(--mj-blue);
            padding: 6px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 48%; /* 2 columnas */
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .mj-skill-name {
            font-weight: bold;
            font-size: 12px;
            color: #333;
        }
        .mj-skill-level {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            font-weight: bold;
        }

        /* DISEÑO MEJORADO: PASATIEMPOS (Minimalist Caps) */
        .mj-hobbies-modern-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .mj-hobby-tag {
            color: var(--mj-blue);
            font-size: 11px;
            font-weight: bold;
            padding: 4px 0;
            margin-right: 15px;
            border-bottom: 1px dotted var(--mj-blue);
            display: inline-flex;
            align-items: center;
            gap: 5px;
            text-transform: uppercase;
        }
        
        /* Footer Inferior */
        .mj-bottom-bar {
            background-color: var(--mj-blue);
            height: 20px;
            width: 100%;
            position: absolute;
            bottom: 0;
            left: 0;
        }
        
        /* Contenedor Flex para las 2 columnas principales de contenido */
        .mj-content-flex {
            display: flex;
            justify-content: space-between;
        }
        .mj-col-left-wide { width: 45%; }
        .mj-col-right-wide { width: 100%; }
        
        /* Helper para drag and drop area vacía */
        .sortable-drop-area {
            min-height: 100px;
        }

    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <nav class="bg-primary/90 backdrop-blur-md border-b border-white/10 h-20 flex-shrink-0 z-50 relative no-print">
        <div class="container mx-auto px-4 h-full flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="Selecionatuforma.html" class="flex items-center gap-2 text-gray-300 hover:text-white transition">
                    <i class="fa-solid fa-arrow-left"></i> <span class="hidden sm:inline">Volver</span>
                </a>
                <a href="biblioteca-de-plantillas.html" class="bg-purple-600/20 border border-purple-500 text-purple-300 px-3 py-1 rounded-full text-xs font-bold hover:bg-purple-600 hover:text-white transition flex items-center gap-2">
                    <i class="fa-solid fa-swatchbook"></i> Biblioteca de Plantillas
                </a>
            </div>
            
            <div class="flex items-center gap-2 hidden md:flex">
                <span class="font-heading font-bold text-lg">CREADOR DE CV</span>
                <span class="text-xs text-gray-500 bg-gray-800 px-2 py-1 rounded" id="template-name-display">Plantilla: Martin Janssen</span>
            </div>

            <div class="flex gap-3">
                <button onclick="downloadPDFDirect()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-sm transition flex items-center gap-2 shadow-lg shadow-green-900/50">
                    <i class="fa-solid fa-file-pdf"></i> <span class="hidden sm:inline">Descargar PDF</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden relative">
        
        <div class="w-full md:w-1/2 lg:w-5/12 editor-panel p-6 pb-32 no-print custom-scrollbar">
            
            <div class="mb-6 bg-blue-900/20 border border-blue-500/30 p-4 rounded-lg">
                <h2 class="text-xl font-bold text-blue-400 mb-1">Editor Inteligente</h2>
                <p class="text-xs text-gray-400 mb-2">Datos guardados automáticamente. Usa los controles de tamaño para ajustar el diseño.</p>
                
                <div class="bg-blue-600/20 p-2 rounded border border-blue-500/50 mt-2">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="use-two-pages" class="w-4 h-4 text-blue-600 bg-gray-700 rounded border-gray-600 focus:ring-blue-500 focus:ring-2" onchange="updateCV()">
                        <div>
                            <span class="text-sm font-bold text-white block">Activar 2ª Hoja A4</span>
                            <span class="text-[10px] text-gray-300 block leading-tight">Si el contenido es mucho, bajará automáticamente.</span>
                        </div>
                    </label>
                    <p class="text-red-400 text-[10px] italic mt-1 ml-7 font-bold">
                        <i class="fa-solid fa-triangle-exclamation"></i> La reorganización automática de la 2 hoja A4 puede fallar en móviles, Usa una PC.
                    </p>
                </div>
            </div>

            <div class="mb-4 border border-white/10 rounded-lg overflow-hidden bg-black/20">
                <div class="accordion-header bg-white/5 p-4 flex justify-between items-center" onclick="toggleAccordion('acc-personal')">
                    <h3 class="font-bold flex items-center gap-2 text-sm uppercase"><i class="fa-solid fa-user text-blue-400"></i> Datos Personales</h3>
                    <i class="fa-solid fa-chevron-down text-xs"></i>
                </div>
                <div id="acc-personal" class="accordion-content active p-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="cv-label">Nombre</label><input type="text" class="cv-input" id="input-name" placeholder="Juan" oninput="updateCV()"></div>
                        <div><label class="cv-label">Apellido</label><input type="text" class="cv-input" id="input-lastname" placeholder="Pérez" oninput="updateCV()"></div>
                    </div>
                    
                    <label class="cv-label">Puesto / Título Profesional</label>
                    <input type="text" class="cv-input" id="input-title" placeholder="Ej: Arquitecto de Software" oninput="updateCV()">
                    
                    <label class="cv-label">Foto de Perfil</label>
                    <div class="bg-black/30 p-3 rounded-lg border border-white/10">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-gray-300">Mostrar foto</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="check-photo" class="sr-only peer" checked onchange="togglePhotoDisplay(); updateCV()">
                                <div class="w-9 h-5 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <input type="file" id="input-photo" accept="image/*" class="text-xs text-gray-400 w-full file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700" onchange="previewPhoto()">
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                        <div><label class="cv-label">Email</label><input type="email" class="cv-input" id="input-email" oninput="updateCV()"></div>
                        <div><label class="cv-label">Teléfono</label><input type="tel" class="cv-input" id="input-phone" oninput="updateCV()"></div>
                    </div>

                    <div class="pt-4 mt-4 border-t border-white/10">
                        <p class="text-xs text-blue-400 font-bold mb-3 uppercase">Detalles Adicionales</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="cv-label">Nacimiento</label><input type="date" class="cv-input" id="input-birth" oninput="updateCV()"></div>
                            <div><label class="cv-label">Nacionalidad</label><input type="text" class="cv-input" id="input-nationality" oninput="updateCV()"></div>
                            <div><label class="cv-label">Estado Civil</label><input type="text" class="cv-input" id="input-civil" placeholder="Ej: Soltero" oninput="updateCV()"></div>
                            <div><label class="cv-label">Licencia</label><select class="cv-select" id="input-license" onchange="updateCV()"><option value="No">No</option><option value="Sí">Sí</option></select></div>
                            <div class="col-span-2"><label class="cv-label">Dirección</label><input type="text" class="cv-input" id="input-address" oninput="updateCV()"></div>
                            <div><label class="cv-label">Código Postal</label><input type="text" class="cv-input" id="input-zip" oninput="updateCV()"></div>
                            <div><label class="cv-label">Ciudad</label><input type="text" class="cv-input" id="input-city" oninput="updateCV()"></div>
                            <div class="col-span-2"><label class="cv-label">LinkedIn</label><input type="text" class="cv-input" id="input-linkedin" placeholder="linkedin.com/in/..." oninput="updateCV()"></div>
                            <div class="col-span-2"><label class="cv-label">Sitio Web</label><input type="text" class="cv-input" id="input-website" placeholder="www.miportfolio.com" oninput="updateCV()"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-4 border border-white/10 rounded-lg overflow-hidden bg-black/20">
                <div class="accordion-header bg-white/5 p-4 flex justify-between items-center" onclick="toggleAccordion('acc-profile')">
                    <h3 class="font-bold flex items-center gap-2 text-sm uppercase"><i class="fa-solid fa-align-left text-blue-400"></i> Perfil Personal</h3>
                    <i class="fa-solid fa-chevron-down text-xs"></i>
                </div>
                <div id="acc-profile" class="accordion-content p-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="cv-label m-0">Texto del Perfil</label>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-gray-400">Tamaño:</span>
                            <input type="range" class="config-slider w-20" id="size-profile" min="60" max="120" value="100" oninput="updateCV()">
                        </div>
                    </div>
                    <div class="relative">
                        <textarea class="cv-input h-40" id="input-profile" maxlength="1000" placeholder="Escribe aquí tu perfil..." oninput="updateCV()"></textarea>
                        <button id="btn-ai-profile" class="absolute bottom-2 right-2 text-xs bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded transition flex items-center gap-1 shadow-lg" onclick="improveTextAI('input-profile', 'btn-ai-profile')">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Mejorar con IA
                        </button>
                    </div>
                    <p class="warning-text">Para evitar que su texto se salga de la hoja, Considere tocar ENTER para cambiar de línea y seguir escribiendo.</p>
                </div>
            </div>

            <div class="mb-4 border border-white/10 rounded-lg overflow-hidden bg-black/20">
                <div class="accordion-header bg-white/5 p-4 flex justify-between items-center" onclick="toggleAccordion('acc-exp')">
                    <h3 class="font-bold flex items-center gap-2 text-sm uppercase"><i class="fa-solid fa-briefcase text-blue-400"></i> Experiencia Laboral</h3>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-gray-400">Tamaño:</span>
                        <input type="range" class="config-slider w-16" id="size-experience" min="70" max="110" value="100" oninput="updateCV()" onclick="event.stopPropagation()">
                        <i class="fa-solid fa-chevron-down text-xs ml-2"></i>
                    </div>
                </div>
                <div id="acc-exp" class="accordion-content p-4">
                    <div id="experience-container"></div>
                    <button class="w-full py-2 bg-blue-600/30 border border-blue-500/50 text-blue-300 rounded hover:bg-blue-600/50 transition mt-3 text-sm font-bold" onclick="addExperience()">
                        <i class="fa-solid fa-plus"></i> Agregar Empleo
                    </button>
                </div>
            </div>

            <div class="mb-4 border border-white/10 rounded-lg overflow-hidden bg-black/20">
                <div class="accordion-header bg-white/5 p-4 flex justify-between items-center" onclick="toggleAccordion('acc-edu')">
                    <h3 class="font-bold flex items-center gap-2 text-sm uppercase"><i class="fa-solid fa-graduation-cap text-blue-400"></i> Educación</h3>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-gray-400">Tamaño:</span>
                        <input type="range" class="config-slider w-16" id="size-education" min="70" max="110" value="100" oninput="updateCV()" onclick="event.stopPropagation()">
                        <i class="fa-solid fa-chevron-down text-xs ml-2"></i>
                    </div>
                </div>
                <div id="acc-edu" class="accordion-content p-4">
                    <div id="education-container"></div>
                    <button class="w-full py-2 bg-blue-600/30 border border-blue-500/50 text-blue-300 rounded hover:bg-blue-600/50 transition mt-3 text-sm font-bold" onclick="addEducation()">
                        <i class="fa-solid fa-plus"></i> Agregar Educación
                    </button>
                </div>
            </div>

            <div class="mb-4 border border-white/10 rounded-lg overflow-hidden bg-black/20">
                <div class="accordion-header bg-white/5 p-4 flex justify-between items-center" onclick="toggleAccordion('acc-skills')">
                    <h3 class="font-bold flex items-center gap-2 text-sm uppercase"><i class="fa-solid fa-sliders text-blue-400"></i> Habilidades</h3>
                    <i class="fa-solid fa-chevron-down text-xs"></i>
                </div>
                <div id="acc-skills" class="accordion-content p-4">
                    <div id="skills-container" class="space-y-2"></div>
                    <button class="w-full py-2 bg-blue-600/30 border border-blue-500/50 text-blue-300 rounded hover:bg-blue-600/50 transition mt-3 text-sm font-bold" onclick="addSkill()">
                        <i class="fa-solid fa-plus"></i> Agregar Habilidad
                    </button>
                </div>
            </div>

            <div class="mb-4 border border-white/10 rounded-lg overflow-hidden bg-black/20">
                <div class="accordion-header bg-white/5 p-4 flex justify-between items-center" onclick="toggleAccordion('acc-extras')">
                    <h3 class="font-bold flex items-center gap-2 text-sm uppercase"><i class="fa-solid fa-star text-blue-400"></i> Extras & Custom</h3>
                    <i class="fa-solid fa-chevron-down text-xs"></i>
                </div>
                <div id="acc-extras" class="accordion-content p-4">
                    
                    <div class="mb-4">
                        <label class="cv-label text-green-400">Idiomas</label>
                        <div id="languages-container" class="space-y-2"></div>
                        <button class="text-xs text-green-400 mt-1 hover:text-green-300 underline" onclick="addLanguage()"><i class="fa-solid fa-plus"></i> Agregar Idioma</button>
                    </div>

                    <div class="mb-4 pt-4 border-t border-white/10">
                        <label class="cv-label text-yellow-400">Pasatiempos / Intereses</label>
                        <div id="hobbies-container" class="space-y-2"></div>
                        <button class="text-xs text-yellow-400 mt-1 hover:text-yellow-300 underline" onclick="addHobby()"><i class="fa-solid fa-plus"></i> Agregar Interés (Max 5)</button>
                    </div>

                    <div class="mb-4 pt-4 border-t border-white/10">
                        <div class="flex justify-between items-center mb-1">
                            <label class="cv-label text-purple-400 m-0">Cursos y Certificados</label>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-gray-400">Tamaño:</span>
                                <input type="range" class="config-slider w-16" id="size-courses" min="70" max="110" value="100" oninput="updateCV()">
                            </div>
                        </div>
                        <div id="courses-container" class="space-y-3"></div>
                        <button class="text-xs text-purple-400 mt-1 hover:text-purple-300 underline" onclick="addCourse()"><i class="fa-solid fa-plus"></i> Agregar Curso</button>
                    </div>

                    <div id="custom-sections-wrapper"></div>
                    <button class="w-full py-2 bg-slate-700 text-gray-300 rounded hover:bg-slate-600 transition mt-4 text-xs font-bold border border-slate-600" onclick="addCustomSectionBlock()">
                        <i class="fa-solid fa-plus"></i> Agregar Sección Personalizada (Max 2)
                    </button>
                </div>
            </div>

        </div>

        <div class="hidden md:flex w-1/2 lg:w-7/12 bg-gray-800 justify-center overflow-y-auto relative no-print p-8 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
            <div class="scale-90 origin-top transition-transform duration-300" id="preview-wrapper"> 
                
                <div id="print-area">
                    
                    <div id="cv-page-1" class="a4-page shadow-2xl martin-cv-page">
                        
                        <div class="mj-top-header">
                            <span>CURRICULUM VITAE</span>
                        </div>
                
                        <div class="mj-main-content">
                            <h1 id="display-fullname-p1" class="mj-fullname">MARTIN JANSSEN</h1>
                            <h2 id="display-title-p1" class="mj-title">PROFESIONAL</h2>
                
                            <div class="mj-personal-info-container">
                                <div class="mj-info-left" id="sortable-left-p1">
                                    <div class="draggable-item" id="section-contact-p1">
                                        <div class="mj-section-header">DATOS PERSONALES</div>
                                        <table class="mj-table">
                                            <tr><td class="mj-label">Dirección</td><td class="mj-value" id="display-location-p1"></td></tr>
                                            <tr><td class="mj-label">Teléfono</td><td class="mj-value" id="display-phone-p1"></td></tr>
                                            <tr><td class="mj-label">E-mail</td><td class="mj-value" id="display-email-p1"></td></tr>
                                            
                                            <tr class="hidden" id="li-linkedin-p1"><td class="mj-label">LinkedIn</td><td class="mj-value" id="display-linkedin-p1"></td></tr>
                                            <tr class="hidden" id="li-website-p1"><td class="mj-label">Sitio Web</td><td class="mj-value" id="display-website-p1"></td></tr>
                                        </table>
                                        
                                        <div id="block-extra-info-p1" class="hidden">
                                            <table class="mj-table">
                                                <tr><td class="mj-label">F. Nacimiento</td><td class="mj-value" id="display-birth-p1"></td></tr>
                                                <tr><td class="mj-label">Nacionalidad</td><td class="mj-value" id="display-nationality-p1"></td></tr>
                                                <tr><td class="mj-label">Estado Civil</td><td class="mj-value" id="display-civil-p1"></td></tr>
                                                <tr><td class="mj-label">Licencia</td><td class="mj-value" id="display-license-p1"></td></tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <div class="draggable-item" id="display-photo-container-p1">
                                    <div class="mj-photo-box">
                                        <img id="display-photo-p1" src="https://via.placeholder.com/160x195?text=FOTO" alt="Foto" style="width:100%; height:100%; object-fit:cover;">
                                    </div>
                                </div>
                            </div>
                
                            <div class="mj-content-flex">
                                <div class="mj-col-right-wide sortable-drop-area" id="sortable-right">
                                    
                                    <div class="draggable-item section-block" id="section-profile">
                                        <div class="mj-section-header">PERFIL</div>
                                        <div id="wrapper-profile" style="transform-origin: top left;">
                                            <p class="mj-body-text" id="display-profile">
                                                Descripción profesional...
                                            </p>
                                        </div>
                                    </div>

                                    <div class="draggable-item section-block" id="section-experience">
                                        <div class="mj-section-header">EXPERIENCIA</div>
                                        <div id="display-experience" style="transform-origin: top left;"></div>
                                    </div>
                
                                    <div class="draggable-item section-block" id="section-education">
                                        <div class="mj-section-header">EDUCACIÓN</div>
                                        <div id="display-education" style="transform-origin: top left;"></div>
                                    </div>

                                    <div class="draggable-item section-block hidden" id="block-courses">
                                        <div class="mj-section-header">CURSOS</div>
                                        <div id="display-courses" style="transform-origin: top left;"></div>
                                    </div>

                                    <div id="display-custom-sections-container"></div>
                                    
                                    <div class="draggable-item section-block mt-4" id="section-skills">
                                         <div id="block-languages" class="hidden mb-3">
                                            <div class="mj-section-header">IDIOMAS</div>
                                            <div id="display-languages" class="mj-skills-modern-container"></div>
                                        </div>
                                        <div class="mj-section-header">INFORMÁTICA / HABILIDADES</div>
                                        <div id="display-skills" class="mj-skills-modern-container"></div>
                                    </div>

                                    <div id="block-hobbies" class="draggable-item hidden mt-4">
                                        <div class="mj-section-header">INTERESES PERSONALES</div>
                                        <div id="display-hobbies" class="mj-hobbies-modern-container"></div>
                                    </div>

                                </div>
                            </div>

                        </div>
                
                        <div class="mj-bottom-bar"></div>
                    </div>

                    <div id="cv-page-2" class="a4-page shadow-2xl martin-cv-page hidden">
                        <div class="mj-top-header"><span>CURRICULUM VITAE (CONT.)</span></div>
                        <div class="mj-main-content">
                            <div class="mj-content-flex mt-8">
                                <div class="mj-col-right-wide sortable-drop-area" id="sortable-right-p2">
                                    </div>
                            </div>
                        </div>
                        <div class="mj-bottom-bar"></div>
                    </div>

                </div> </div>
        </div>

    </div>

    <div class="fixed bottom-6 right-6 md:hidden z-50 no-print">
        <button onclick="toggleMobileModal()" class="bg-blue-600 hover:bg-blue-500 text-white rounded-full p-4 shadow-2xl animate-bounce">
            <i class="fa-solid fa-eye text-xl"></i>
        </button>
    </div>

    <div id="mobile-modal" class="mobile-preview-modal no-print">
        <div class="p-4">
            <button onclick="toggleMobileModal()" class="fixed top-4 right-4 bg-red-600 text-white p-2 rounded-full z-50 shadow-lg">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <div class="flex justify-center min-h-screen pt-12 pb-20">
                <div id="mobile-cv-clone-container" class="origin-top scale-[0.45] sm:scale-75 shadow-2xl"></div>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABLES GLOBALES ---
        let experienceCount = 0;
        let educationCount = 0;
        let skillCount = 0;
        let langCount = 0;
        let courseCount = 0;
        let hobbyCount = 0;
        let customSectionsCount = 0;
        const maxExp = 5;
        const maxEdu = 3;
        const maxCustom = 2;
        const maxHobbies = 5;

        // --- INICIALIZACIÓN ---
        window.onload = function() {
            const savedTemplate = localStorage.getItem('selectedTemplate');
            if (savedTemplate) {
                document.getElementById('template-name-display').innerText = `Plantilla: ${savedTemplate}`;
            }

            // Inicializar inputs
            addExperience();
            addEducation();
            addSkill();
            addLanguage();
            addCourse();
            addHobby(); // Inicia con 1 hobby
            
            // Cargar datos
            loadData();
            
            // Render
            updateCV();

            // Init Sortables
            initSortables();
        };

        function initSortables() {
            // Configuración Robusta para Móvil y PC
            const commonOptions = {
                animation: 150,
                ghostClass: 'sortable-ghost',
                delay: 200, // Vital para móviles (distingue click de drag)
                delayOnTouchOnly: true,
                touchStartThreshold: 5,
                draggable: '.draggable-item',
                fallbackOnBody: true,
                swapThreshold: 0.65
            };

            // Columnas Principales Pag 1 (Left)
            new Sortable(document.getElementById('sortable-left-p1'), commonOptions);
            
            // Columnas Principales Pag 1 y 2 (Right) - CONFIGURADO PARA ARRASTRAR ENTRE PAGINAS
            const sharedGroup = {
                name: 'shared-sections',
                pull: true,
                put: true
            };

            new Sortable(document.getElementById('sortable-right'), { 
                ...commonOptions, 
                group: sharedGroup 
            });
            
            new Sortable(document.getElementById('sortable-right-p2'), { 
                ...commonOptions, 
                group: sharedGroup 
            });
            
            // Reordenamiento Interno (Listas)
            const internalOptions = { ...commonOptions, draggable: '> div' }; // Arrastrar hijos directos
            new Sortable(document.getElementById('display-experience'), internalOptions);
            new Sortable(document.getElementById('display-education'), internalOptions);
            new Sortable(document.getElementById('display-courses'), internalOptions);
        }

        // --- GESTIÓN DE DATOS ---
        function saveData() {
            const data = {
                name: val('input-name'),
                lastname: val('input-lastname'),
                title: val('input-title'),
                email: val('input-email'),
                phone: val('input-phone'),
                address: val('input-address'),
                city: val('input-city'),
                zip: val('input-zip'),
                linkedin: val('input-linkedin'),
                website: val('input-website'),
                birth: val('input-birth'),
                nationality: val('input-nationality'),
                civil: val('input-civil'),
                license: val('input-license'),
                profile: val('input-profile'),
                showPhoto: document.getElementById('check-photo').checked,
                useTwoPages: document.getElementById('use-two-pages').checked,
                // Guardar tamaños
                sizeProfile: val('size-profile'),
                sizeExp: val('size-experience'),
                sizeEdu: val('size-education'),
                sizeCourses: val('size-courses'),
            };
            localStorage.setItem('cvDataStudio33', JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem('cvDataStudio33');
            if(saved) {
                const data = JSON.parse(saved);
                if(data.name) document.getElementById('input-name').value = data.name;
                if(data.lastname) document.getElementById('input-lastname').value = data.lastname;
                if(data.title) document.getElementById('input-title').value = data.title;
                if(data.email) document.getElementById('input-email').value = data.email;
                if(data.phone) document.getElementById('input-phone').value = data.phone;
                if(data.address) document.getElementById('input-address').value = data.address;
                if(data.city) document.getElementById('input-city').value = data.city;
                if(data.zip) document.getElementById('input-zip').value = data.zip;
                if(data.linkedin) document.getElementById('input-linkedin').value = data.linkedin;
                if(data.website) document.getElementById('input-website').value = data.website;
                if(data.birth) document.getElementById('input-birth').value = data.birth;
                if(data.nationality) document.getElementById('input-nationality').value = data.nationality;
                if(data.civil) document.getElementById('input-civil').value = data.civil;
                if(data.license) document.getElementById('input-license').value = data.license;
                if(data.profile) document.getElementById('input-profile').value = data.profile;
                if(data.showPhoto !== undefined) document.getElementById('check-photo').checked = data.showPhoto;
                if(data.useTwoPages !== undefined) document.getElementById('use-two-pages').checked = data.useTwoPages;
                
                if(data.sizeProfile) document.getElementById('size-profile').value = data.sizeProfile;
                if(data.sizeExp) document.getElementById('size-experience').value = data.sizeExp;
                if(data.sizeEdu) document.getElementById('size-education').value = data.sizeEdu;
                if(data.sizeCourses) document.getElementById('size-courses').value = data.sizeCourses;
            }
        }

        // --- LÓGICA DE ACTUALIZACIÓN ---
        function updateCV() {
            saveData(); 

            // RENDER BASE (Todo en Pag 1 primero)
            const name = val('input-name') || 'Juan';
            const lastname = val('input-lastname') || 'Pérez';
            const fullName = `${name} ${lastname}`;
            
            txt('display-fullname-p1', fullName);
            
            txt('display-title-p1', val('input-title') || 'Profesional');
            
            txt('display-email-p1', val('input-email') || 'email@ejemplo.com');
            txt('display-phone-p1', val('input-phone') || '+123 456 789');
            
            const addr = val('input-address');
            const city = val('input-city');
            const zip = val('input-zip');
            txt('display-location-p1', `${addr ? addr + ', ' : ''}${city || 'Ciudad'}${zip ? ' (' + zip + ')' : ''}`);

            toggleDisplay('li-linkedin-p1', val('input-linkedin'), 'display-linkedin-p1');
            toggleDisplay('li-website-p1', val('input-website'), 'display-website-p1');

            const birth = val('input-birth');
            const nat = val('input-nationality');
            const civil = val('input-civil');
            const lic = val('input-license');

            if (birth || nat || civil || lic) {
                document.getElementById('block-extra-info-p1').classList.remove('hidden');
                txt('display-birth-p1', formatDate(birth));
                txt('display-nationality-p1', nat);
                txt('display-civil-p1', civil);
                txt('display-license-p1', lic);
            } else {
                document.getElementById('block-extra-info-p1').classList.add('hidden');
            }

            txt('display-profile', val('input-profile') || 'Tu perfil profesional...');
            
            togglePhotoDisplay();

            // Aplicar Tamaños
            applyFontSize('wrapper-profile', 'size-profile');
            applyFontSize('display-experience', 'size-experience');
            applyFontSize('display-education', 'size-education');
            applyFontSize('display-courses', 'size-courses');

            renderExperience();
            renderEducation();
            renderSkills();
            renderLanguages();
            renderCourses();
            renderHobbies();
            renderCustomSections();

            // GESTIÓN DE PAGINACIÓN (AUTO-FLOW)
            managePagination();
        }

        function managePagination() {
            const use2Pages = document.getElementById('use-two-pages').checked;
            const page2 = document.getElementById('cv-page-2');
            const col1 = document.getElementById('sortable-right'); // Origen
            const col2 = document.getElementById('sortable-right-p2'); // Destino

            // 1. Resetear: Mover todo de vuelta a Pág 1 para recalcular
            while(col2.children.length > 0) {
                col1.appendChild(col2.children[0]);
            }

            if (!use2Pages) {
                page2.classList.add('hidden');
                return;
            }

            page2.classList.remove('hidden');

            // 2. Calcular desbordamiento
            // La hoja mide aprox 1120px de alto. Restamos cabecera y márgenes.
            // Límite seguro aprox 950px para el contenido de la columna derecha en Pág 1.
            const limitHeight = 940; 
            const children = Array.from(col1.children);
            
            let currentHeight = 0;
            let moved = false;
            
            children.forEach(child => {
                // Si el elemento está visible y hace que la altura supere el límite
                if (child.offsetTop + child.offsetHeight > limitHeight || moved) {
                    col2.appendChild(child);
                    moved = true; // Una vez que uno se mueve, todos los siguientes también
                }
            });
        }

        function applyFontSize(targetId, sliderId) {
            const size = document.getElementById(sliderId).value;
            const el = document.getElementById(targetId);
            if(el) {
                // Usar transform scale en lugar de zoom para mejor compatibilidad y evitar glitches de layout
                el.style.zoom = `${size}%`; 
            }
        }

        function val(id) { return document.getElementById(id) ? document.getElementById(id).value : ''; }
        function txt(id, text) { if(document.getElementById(id)) document.getElementById(id).innerText = text; }
        function toggleDisplay(eleId, value, textId) {
            const el = document.getElementById(eleId);
            if(value) { el.classList.remove('hidden'); txt(textId, value); } 
            else { el.classList.add('hidden'); }
        }
        function formatDate(dateStr) {
            if(!dateStr) return '';
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        }

        function previewPhoto() {
            const file = document.getElementById('input-photo').files[0];
            const reader = new FileReader();
            reader.onloadend = function () { document.getElementById('display-photo-p1').src = reader.result; }
            if (file) reader.readAsDataURL(file);
        }
        
        function togglePhotoDisplay() {
            const container = document.getElementById('display-photo-container-p1');
            const isChecked = document.getElementById('check-photo').checked;
            if (isChecked) {
                container.style.display = 'block'; 
                container.style.visibility = 'visible';
            } else {
                container.style.display = 'none'; 
            }
        }

        function toggleAccordion(id) {
            document.getElementById(id).classList.toggle('active');
        }

        // --- IA MEJORADA ---
        async function improveTextAI(inputId, btnId) {
            const input = document.getElementById(inputId);
            const btn = document.getElementById(btnId);
            const original = input.value;
            
            if(!original) return alert("Escribe algo primero.");
            if(original.length < 5) return alert("Texto muy corto.");

            const originalBtnText = btn.innerHTML;
            btn.innerHTML = `<i class="fa-solid fa-spinner ai-loading"></i>`;
            btn.disabled = true;

            try {
                // PROMPT MEJORADO
                const prompt = `Actúa como un reclutador senior experto. Reescribe el siguiente texto para un currículum vitae profesional de alto impacto. Usa verbos de acción, sé conciso, elimina redundancias y mantén un tono formal y persuasivo. Texto: "${original}"`;
                
                const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}`);
                if (!response.ok) throw new Error('Error API');
                const improvedText = await response.text();
                input.value = improvedText.replace(/^"|"$/g, '').trim();
                updateCV();
            } catch (error) {
                input.value = original + " (Error de conexión, intente luego)"; 
                updateCV();
            } finally {
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
            }
        }

        // --- RENDERIZADO DINÁMICO ---

        function addExperience() {
            if (experienceCount >= maxExp) return;
            experienceCount++;
            const id = experienceCount;
            const html = `
                <div class="bg-white/5 p-3 rounded mb-3 border border-white/10" id="exp-form-${id}">
                    <div class="flex justify-between mb-2"><span class="text-xs font-bold text-blue-300">Exp ${id}</span><button class="text-red-400 text-xs" onclick="removeEl('exp-form-${id}'); updateCV()"><i class="fa-solid fa-trash"></i></button></div>
                    <input type="text" class="cv-input mb-2" id="exp-role-${id}" placeholder="Puesto" oninput="updateCV()">
                    <input type="text" class="cv-input mb-2" id="exp-comp-${id}" placeholder="Compañía" oninput="updateCV()">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div><label class="text-[10px] text-gray-400">Inicio</label><input type="date" class="cv-input text-xs" id="exp-start-${id}" oninput="updateCV()"></div>
                        <div><label class="text-[10px] text-gray-400">Fin</label><input type="date" class="cv-input text-xs" id="exp-end-${id}" oninput="updateCV()"></div>
                    </div>
                    <label class="flex items-center gap-2 mb-2 text-xs text-gray-400"><input type="checkbox" id="exp-current-${id}" onchange="updateCV()"> Trabajo actual</label>
                    <div class="relative mb-2">
                        <textarea class="cv-input h-20 text-xs" id="exp-desc-${id}" placeholder="Responsabilidades..." oninput="updateCV()"></textarea>
                        <button id="btn-ai-exp-${id}" class="absolute bottom-1 right-1 text-[10px] bg-purple-600 px-2 rounded hover:bg-purple-500" onclick="improveTextAI('exp-desc-${id}', 'btn-ai-exp-${id}')">IA</button>
                    </div>
                    <div class="mt-1"><label class="text-[10px] text-gray-400">Espaciado Inferior</label><input type="range" id="exp-spacing-${id}" min="0" max="40" value="8" oninput="updateCV()"></div>
                </div>`;
            document.getElementById('experience-container').insertAdjacentHTML('beforeend', html);
        }

        function renderExperience() {
            let html = '';
            for(let i=1; i<=experienceCount; i++) {
                if(!document.getElementById(`exp-role-${i}`)) continue;
                const role = val(`exp-role-${i}`);
                const comp = val(`exp-comp-${i}`);
                const start = formatDate(val(`exp-start-${i}`));
                const end = document.getElementById(`exp-current-${i}`).checked ? "Presente" : formatDate(val(`exp-end-${i}`));
                const desc = val(`exp-desc-${i}`);
                const margin = document.getElementById(`exp-spacing-${i}`) ? document.getElementById(`exp-spacing-${i}`).value : 8;

                if(role || comp) {
                    html += `
                    <div style="margin-bottom: ${margin}px;">
                        <div class="mj-job-title">${role}</div>
                        <div class="mj-job-meta">
                            <span>${comp}</span> | <span class="text-[10px] normal-case" style="font-weight:normal;">${start} - ${end}</span>
                        </div>
                        <p class="mj-body-text mt-1">${desc}</p>
                    </div>`;
                }
            }
            document.getElementById('display-experience').innerHTML = html;
        }

        function addEducation() {
            if (educationCount >= maxEdu) return;
            educationCount++;
            const id = educationCount;
            const html = `
                <div class="bg-white/5 p-3 rounded mb-3 border border-white/10" id="edu-form-${id}">
                    <div class="flex justify-between mb-2"><span class="text-xs font-bold text-blue-300">Edu ${id}</span><button class="text-red-400 text-xs" onclick="removeEl('edu-form-${id}'); updateCV()"><i class="fa-solid fa-trash"></i></button></div>
                    <input type="text" class="cv-input mb-2" id="edu-inst-${id}" placeholder="Institución" oninput="updateCV()">
                    <input type="text" class="cv-input mb-2" id="edu-degree-${id}" placeholder="Título/Grado" oninput="updateCV()">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div><label class="text-[10px] text-gray-400">Inicio</label><input type="date" class="cv-input text-xs" id="edu-start-${id}" oninput="updateCV()"></div>
                        <div><label class="text-[10px] text-gray-400">Fin</label><input type="date" class="cv-input text-xs" id="edu-end-${id}" oninput="updateCV()"></div>
                    </div>
                    <label class="flex items-center gap-2 text-xs text-gray-400"><input type="checkbox" id="edu-current-${id}" onchange="updateCV()"> En curso</label>
                    <div class="mt-1"><label class="text-[10px] text-gray-400">Espaciado Inferior</label><input type="range" id="edu-spacing-${id}" min="0" max="30" value="6" oninput="updateCV()"></div>
                </div>`;
            document.getElementById('education-container').insertAdjacentHTML('beforeend', html);
        }

        function renderEducation() {
            let html = '';
            for(let i=1; i<=educationCount; i++) {
                if(!document.getElementById(`edu-inst-${i}`)) continue;
                const inst = val(`edu-inst-${i}`);
                const degree = val(`edu-degree-${i}`);
                const start = formatDate(val(`edu-start-${i}`));
                const end = document.getElementById(`edu-current-${i}`).checked ? "Actualidad" : formatDate(val(`edu-end-${i}`));
                const margin = document.getElementById(`edu-spacing-${i}`) ? document.getElementById(`edu-spacing-${i}`).value : 6;

                if(inst || degree) {
                    html += `
                    <div style="margin-bottom: ${margin}px;">
                        <div class="mj-job-title">${degree}</div>
                        <div class="mj-job-meta">
                            <span>${inst}</span> | <span class="text-[10px] normal-case" style="font-weight:normal;">${start} - ${end}</span>
                        </div>
                    </div>`;
                }
            }
            document.getElementById('display-education').innerHTML = html;
        }

        function addCourse() {
            courseCount++;
            const id = courseCount;
            const html = `
                <div class="bg-white/5 p-2 rounded mb-2 border border-white/10" id="course-form-${id}">
                    <div class="flex justify-between"><span class="text-[10px] text-purple-300">Curso</span><button class="text-red-400 text-xs" onclick="removeEl('course-form-${id}'); updateCV()"><i class="fa-solid fa-xmark"></i></button></div>
                    <input type="text" class="cv-input mb-1 text-xs" id="course-title-${id}" placeholder="Nombre del Curso" oninput="updateCV()">
                    <input type="text" class="cv-input mb-1 text-xs" id="course-issuer-${id}" placeholder="Expedido por" oninput="updateCV()">
                    <div class="flex gap-2">
                        <input type="date" class="cv-input text-xs w-1/3" id="course-date-${id}" oninput="updateCV()">
                        <label class="flex items-center gap-1 text-[10px] text-gray-400"><input type="checkbox" id="course-current-${id}" onchange="updateCV()"> En curso</label>
                    </div>
                    <textarea class="cv-input h-10 text-xs mt-1" id="course-sum-${id}" placeholder="Resumen breve..." oninput="updateCV()"></textarea>
                    <div class="mt-1"><label class="text-[10px] text-gray-400">Espaciado Inferior</label><input type="range" id="course-spacing-${id}" min="0" max="20" value="4" oninput="updateCV()"></div>
                </div>`;
            document.getElementById('courses-container').insertAdjacentHTML('beforeend', html);
        }

        function renderCourses() {
            let html = '';
            for(let i=1; i<=courseCount; i++) {
                if(!document.getElementById(`course-title-${i}`)) continue;
                const title = val(`course-title-${i}`);
                const issuer = val(`course-issuer-${i}`);
                const date = document.getElementById(`course-current-${i}`).checked ? "En curso" : formatDate(val(`course-date-${i}`));
                const sum = val(`course-sum-${i}`);
                const margin = document.getElementById(`course-spacing-${i}`) ? document.getElementById(`course-spacing-${i}`).value : 4;

                if(title) {
                    html += `
                    <div style="margin-bottom: ${margin}px;">
                        <div class="mj-job-title" style="font-size:12px !important;">${title}</div>
                        <div class="text-[10px] text-[#555] leading-none mt-0.5">
                            <span>${issuer}</span> | <span class="text-blue-600">${date}</span>
                        </div>
                        ${sum ? `<div class="mj-body-text italic mt-0.5 text-[10px]">${sum}</div>` : ''}
                    </div>`;
                }
            }
            document.getElementById('display-courses').innerHTML = html;
            document.getElementById('block-courses').classList.toggle('hidden', !html);
        }

        function addSkill() { skillCount++; const id = skillCount; const html = `<div class="flex gap-2 items-center mb-2" id="skill-form-${id}"><input type="text" class="cv-input" id="skill-name-${id}" placeholder="Habilidad" oninput="updateCV()"><select class="cv-select w-1/3 text-xs" id="skill-level-${id}" onchange="updateCV()"><option value="Básico">Básico</option><option value="Intermedio">Intermedio</option><option value="Avanzado">Avanzado</option><option value="Experto">Experto</option></select><button class="text-red-400" onclick="removeEl('skill-form-${id}'); updateCV()"><i class="fa-solid fa-xmark"></i></button></div>`; document.getElementById('skills-container').insertAdjacentHTML('beforeend', html); }
        
        // DISEÑO CLEAN CARDS (Más profesional y corporativo)
        function renderSkills() { 
            let html = ''; 
            for(let i=1; i<=skillCount; i++) { 
                if(!document.getElementById(`skill-name-${i}`)) continue; 
                const name = val(`skill-name-${i}`); 
                const level = val(`skill-level-${i}`); 
                
                if(name) html += `
                <div class="mj-skill-card">
                    <span class="mj-skill-name">${name}</span>
                    <span class="mj-skill-level">${level}</span>
                </div>`; 
            } 
            document.getElementById('display-skills').innerHTML = html; 
        }

        function addLanguage() { langCount++; const id = langCount; const commonLangs = ["Inglés", "Español", "Francés", "Alemán", "Italiano", "Portugués", "Chino", "Japonés", "Ruso", "Árabe"]; let options = commonLangs.map(l => `<option value="${l}">${l}</option>`).join(''); const html = `<div class="flex gap-2 items-center mb-2" id="lang-form-${id}"><select class="cv-select text-xs" id="lang-name-${id}" onchange="updateCV()">${options}</select><select class="cv-select w-1/3 text-xs" id="lang-level-${id}" onchange="updateCV()"><option value="A1 (Básico)">A1 (Básico)</option><option value="A2 (Básico)">A2 (Básico)</option><option value="B1 (Intermedio)">B1 (Intermedio)</option><option value="B2 (Intermedio)">B2 (Intermedio)</option><option value="C1 (Avanzado)">C1 (Avanzado)</option><option value="C2 (Maestría)">C2 (Maestría)</option><option value="Nativo">Nativo</option></select><button class="text-red-400" onclick="removeEl('lang-form-${id}'); updateCV()"><i class="fa-solid fa-xmark"></i></button></div>`; document.getElementById('languages-container').insertAdjacentHTML('beforeend', html); }
        
        function renderLanguages() { 
            let html = ''; 
            for(let i=1; i<=langCount; i++) { 
                if(!document.getElementById(`lang-name-${i}`)) continue; 
                const name = val(`lang-name-${i}`); 
                const level = val(`lang-level-${i}`); 
                html += `
                <div class="mj-skill-card" style="border-left-color: #3b82f6;">
                    <span class="mj-skill-name" style="color:#1d4ed8;">${name}</span>
                    <span class="mj-skill-level">${level}</span>
                </div>`; 
            } 
            document.getElementById('display-languages').innerHTML = html; 
            document.getElementById('block-languages').classList.toggle('hidden', !html); 
        }

        function addHobby() { 
            if(hobbyCount >= maxHobbies) return;
            hobbyCount++; 
            const id = hobbyCount; 
            const html = `<div class="flex gap-2 items-center mb-2" id="hobby-form-${id}"><input type="text" class="cv-input text-xs" id="hobby-name-${id}" placeholder="Pasatiempo" oninput="updateCV()"><button class="text-red-400" onclick="removeEl('hobby-form-${id}'); updateCV()"><i class="fa-solid fa-xmark"></i></button></div>`; 
            document.getElementById('hobbies-container').insertAdjacentHTML('beforeend', html); 
        }
        
        // DISEÑO CLEAN TAGS (Minimalista)
        function renderHobbies() { 
            let html = ''; 
            for(let i=1; i<=hobbyCount; i++) { 
                if(!document.getElementById(`hobby-name-${i}`)) continue; 
                const valH = document.getElementById(`hobby-name-${i}`).value; 
                if(valH) html += `<div class="mj-hobby-tag"><i class="fa-solid fa-check"></i> ${valH}</div>`; 
            } 
            document.getElementById('display-hobbies').innerHTML = html; 
            document.getElementById('block-hobbies').classList.toggle('hidden', !html); 
        }

        // --- DOBLE SECCIÓN PERSONALIZADA (Robustez IDs) ---
        function addCustomSectionBlock() {
            if (customSectionsCount >= maxCustom) return;
            customSectionsCount++;
            const id = customSectionsCount;
            const html = `
                <div class="mt-4 pt-4 border-t-2 border-blue-500/30" id="custom-block-${id}">
                    <div class="flex justify-between"><p class="text-xs text-blue-400 font-bold mb-3 uppercase flex items-center gap-2"><i class="fa-solid fa-pen-to-square"></i> Custom #${id}</p><button class="text-red-400 text-xs" onclick="removeEl('custom-block-${id}'); updateCV()"><i class="fa-solid fa-trash"></i></button></div>
                    <label class="cv-label">Tipo</label>
                    <select class="cv-select mb-2" id="custom-type-${id}" onchange="renderCustomInputs(${id})">
                        <option value="none">-- Seleccionar --</option>
                        <option value="ref">Referencias</option>
                        <option value="intern">Pasantías</option>
                        <option value="skills_list">Lista Habilidades</option>
                        <option value="period">Periodo/Logros</option>
                        <option value="desc">Texto Libre</option>
                    </select>
                    <div id="custom-inputs-dynamic-${id}"></div>
                </div>`;
            document.getElementById('custom-sections-wrapper').insertAdjacentHTML('beforeend', html);
        }

        function renderCustomInputs(id) {
            const type = val(`custom-type-${id}`);
            const container = document.getElementById(`custom-inputs-dynamic-${id}`);
            let html = `<input type="text" class="cv-input mb-1" id="cust-title-${id}" placeholder="Título Sección" oninput="updateCV()">`;
            
            if (type === 'ref') {
                html += `<input type="text" class="cv-input mb-1" id="cust-field1-${id}" placeholder="Nombre Referencia" oninput="updateCV()">
                         <input type="text" class="cv-input mb-1" id="cust-field2-${id}" placeholder="Contacto" oninput="updateCV()">
                         <input type="text" class="cv-input" id="cust-field3-${id}" placeholder="Relación" oninput="updateCV()">`;
            } else if (type === 'intern') {
                html += `<input type="text" class="cv-input mb-1" id="cust-field1-${id}" placeholder="Rol" oninput="updateCV()">
                         <input type="text" class="cv-input mb-1" id="cust-field2-${id}" placeholder="Empresa" oninput="updateCV()">
                         <textarea class="cv-input h-16" id="cust-field3-${id}" placeholder="Descripción" oninput="updateCV()"></textarea>`;
            } else if (type === 'period') {
                html += `<input type="text" class="cv-input mb-1" id="cust-field1-${id}" placeholder="Logro" oninput="updateCV()">
                         <div class="flex gap-2"><input type="date" class="cv-input" id="cust-field2-${id}" oninput="updateCV()"><input type="date" class="cv-input" id="cust-field3-${id}" oninput="updateCV()"></div>`;
            } else { // desc or skills
                html += `<textarea class="cv-input h-24" id="cust-field1-${id}" placeholder="Contenido..." oninput="updateCV()"></textarea>`;
            }
            container.innerHTML = html;
            updateCV();
        }

        function renderCustomSections() {
            let html = '';
            for(let i=1; i<=customSectionsCount; i++) {
                if(!document.getElementById(`custom-block-${i}`)) continue;
                const type = val(`custom-type-${i}`);
                if(type === 'none') continue;
                
                const title = val(`cust-title-${i}`) || 'Sección Personalizada';
                let content = '';

                // Lógica de renderizado según tipo
                if(type === 'ref') {
                    content = `<strong>${val(`cust-field1-${i}`)}</strong><br>${val(`cust-field3-${i}`)}<br><span class="text-xs text-cvAccent">${val(`cust-field2-${i}`)}</span>`;
                } else if(type === 'intern') {
                    content = `<strong>${val(`cust-field1-${i}`)}</strong> en ${val(`cust-field2-${i}`)}<br><span class="mj-body-text">${val(`cust-field3-${i}`)}</span>`;
                } else if(type === 'period') {
                    content = `<strong>${val(`cust-field1-${i}`)}</strong><br><span class="text-xs text-gray-500">${formatDate(val(`cust-field2-${i}`))} - ${formatDate(val(`cust-field3-${i}`))}</span>`;
                } else if(type === 'skills_list') {
                     const text = val(`cust-field1-${i}`);
                     content = `<ul class="list-disc pl-4 mj-body-text">${text.split('\n').map(l => l ? `<li>${l}</li>` : '').join('')}</ul>`;
                } else {
                    content = `<div class="mj-body-text">${val(`cust-field1-${i}`).replace(/\n/g, '<br>')}</div>`;
                }

                html += `
                <div class="draggable-item mb-5 section-block">
                    <div class="mj-section-header">${title}</div>
                    <div>${content}</div>
                </div>`;
            }
            document.getElementById('display-custom-sections-container').innerHTML = html;
            
            initSortables();
        }

        function removeEl(id) { document.getElementById(id).remove(); updateCV(); }

        // PDF DESCARGA (MODIFICADO PARA PRINT AREA)
        function downloadPDFDirect() {
            const element = document.getElementById('print-area');
            const opt = {
                margin:       0,
                filename:     'martin_janssen_cv.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function toggleMobileModal() {
            const modal = document.getElementById('mobile-modal');
            const container = document.getElementById('mobile-cv-clone-container');
            const originalCV = document.getElementById('print-area');
            
            if (modal.classList.contains('active')) { 
                modal.classList.remove('active'); 
                container.innerHTML = ''; 
            } else { 
                modal.classList.add('active'); 
                // Clonar todo el área de impresión (incluyendo pag 2)
                const clone = originalCV.cloneNode(true); 
                clone.style.margin = '0'; 
                clone.style.transform = 'scale(1)'; 
                
                // Asegurarnos de que la página 2 sea visible en el móvil si está activada
                const page2 = clone.querySelector('#cv-page-2');
                if (document.getElementById('use-two-pages').checked && page2) {
                     page2.classList.remove('hidden');
                }

                container.appendChild(clone); 
            }
        }
    </script>
</body>
</html>