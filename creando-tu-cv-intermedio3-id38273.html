<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de CV Profesional | CV Studio33</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Open+Sans:wght@400;600&family=Roboto:wght@300;400;700&family=Lato:wght@400;700&family=Oswald:wght@400;700&family=Playfair+Display:wght@400;700&family=Raleway:wght@400;700&family=Merriweather:wght@300;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0f172a',
                        secondary: '#3b82f6',
                        accent: '#6366f1',
                        dark: '#020617',
                        paper: '#ffffff',
                    }
                }
            }
        }
    </script>

    <style>
        /* Variables CSS para Personalización Dinámica */
        :root {
            --cv-primary: #00AED6;  /* Color Principal por defecto */
            --cv-body-font: 'Arial', sans-serif;
            --cv-header-font: 'Arial', sans-serif;
            --cv-scale: 1; /* Escala de texto */
        }

        /* Estilos Base del Editor */
        body {
            background-color: #0f172a;
            color: white;
            font-family: 'Open Sans', sans-serif;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }

        /* Panel Editor */
        .editor-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            height: calc(100vh - 80px); 
            overflow-y: auto;
        }

        /* Inputs del Editor */
        .cv-input, .cv-select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        .cv-input:focus, .cv-select:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        .cv-select option { background-color: #1e293b; color: white; }

        .cv-label {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
            margin-bottom: 4px;
            font-weight: 600;
            margin-top: 10px;
        }

        /* Acordeón */
        .accordion-header { cursor: pointer; transition: background 0.3s; }
        .accordion-header:hover { background: rgba(255,255,255,0.05); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; }
        .accordion-content.active { max-height: 5000px; }

        .warning-text { font-size: 0.65rem; color: #fbbf24; margin-top: 2px; font-style: italic; }

        /* Estilos AXON */
        .axon-btn {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.5);
            color: #4ade80;
            transition: all 0.3s;
        }
        .axon-btn:hover {
            background: rgba(34, 197, 94, 0.2);
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.2);
        }
        .axon-loading {
            animation: pulse-green 1.5s infinite;
        }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }

        /* --- ESTILOS DE LA PLANTILLA SERGIO MORÁN (PREVIEW) --- */
        
        /* Contenedor A4 */
        .a4-page {
            width: 210mm;
            min-height: 297mm;
            background-color: white;
            padding: 15mm 20mm;
            box-sizing: border-box;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            margin: 0 auto;
            position: relative;
            
            /* Variables aplicadas */
            font-family: var(--cv-body-font);
            color: #333;
            
            /* Transform para zoom en vista previa */
            transform-origin: top center;
            transition: transform 0.3s ease;
            overflow: hidden;
        }

        /* HEADER */
        header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }

        .profile-photo {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-image: url('https://placehold.co/150x150/e2e8f0/1e293b?text=FOTO');
            background-size: cover;
            background-position: center;
            margin-right: 25px;
            border: 1px solid #ddd;
        }

        h1.cv-header-title {
            font-size: calc(24pt * var(--cv-scale));
            color: #444;
            font-weight: bold;
            margin: 0;
            letter-spacing: -0.5px;
            font-family: var(--cv-header-font);
        }

        /* ESTILOS DE SECCIÓN GENERAL */
        .section {
            margin-bottom: 30px;
        }

        h2.section-title {
            font-size: calc(13pt * var(--cv-scale));
            color: #444;
            margin: 0 0 10px 0;
            font-weight: bold;
            font-family: var(--cv-header-font);
        }

        hr {
            border: 0;
            border-top: 2px solid #e0e0e0;
            margin: 0 0 20px 0;
        }

        p {
            margin: 0;
            line-height: 1.5;
            font-size: calc(9.5pt * var(--cv-scale));
            color: #555;
            text-align: justify;
            white-space: pre-wrap;
        }

        /* DETALLES PERSONALES (TABLA) */
        .details-grid {
            display: grid;
            grid-template-columns: 180px 1fr;
            row-gap: 8px;
            font-size: calc(9.5pt * var(--cv-scale));
        }

        .label {
            color: #777;
        }

        .value {
            color: #333;
            font-weight: 500;
        }

        /* TIMELINE (EXPERIENCIA Y EDUCACIÓN) */
        .timeline-item {
            display: flex;
            margin-bottom: 25px;
            page-break-inside: avoid;
        }
        
        /* Columna Fecha */
        .time-col {
            width: 160px;
            font-size: calc(9pt * var(--cv-scale));
            font-weight: bold;
            color: #444;
            padding-top: 2px;
            flex-shrink: 0;
        }

        /* Columna Separador (Línea) */
        .separator-col {
            width: 40px;
            position: relative;
            display: flex;
            justify-content: center;
        }

        .line {
            position: absolute;
            top: 8px;
            bottom: -25px;
            width: 2px;
            background-color: #000;
        }
        
        .timeline-item:last-child .line {
            display: block; 
            height: 100%;
        }

        /* El punto negro */
        .dot {
            width: 8px;
            height: 8px;
            background-color: #000;
            border-radius: 50%;
            z-index: 2;
            margin-top: 5px;
        }

        /* La flecha para educación */
        .arrow-down {
            width: 0; 
            height: 0; 
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 8px solid black;
            z-index: 2;
            margin-top: 5px;
        }

        /* Columna Contenido */
        .content-col {
            flex: 1;
            padding-left: 10px;
        }

        .job-title {
            font-size: calc(10pt * var(--cv-scale));
            font-weight: bold;
            color: var(--cv-primary); /* Aplicamos color principal aquí */
            margin-bottom: 2px;
            display: block;
        }

        .company {
            font-size: calc(9.5pt * var(--cv-scale));
            font-style: italic;
            color: #666;
            margin-bottom: 10px;
            display: block;
        }

        .job-desc {
            font-size: calc(9.5pt * var(--cv-scale));
            color: #555;
            line-height: 1.4;
            margin-bottom: 5px;
            white-space: pre-wrap;
        }

        /* Listas genéricas para Skills o Custom */
        ul.std-list {
            margin: 5px 0 0 0;
            padding-left: 18px;
            font-size: calc(9.5pt * var(--cv-scale));
            color: #555;
            line-height: 1.4;
            list-style-type: disc;
        }
        
        li {
            margin-bottom: 5px;
        }

        /* Drag & Drop Visuals */
        .draggable-item { cursor: grab; position: relative; transition: opacity 0.2s; }
        .sortable-ghost { opacity: 0.4; background: rgba(0,0,0,0.1); }
        
        /* Modal Móvil */
        .mobile-preview-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100; overflow-y: auto; display: none;
        }
        .mobile-preview-modal.active { display: block; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .a4-page { box-shadow: none; margin: 0; width: 100%; height: auto; padding: 15mm 20mm; }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <nav class="bg-primary/90 backdrop-blur-md border-b border-white/10 h-20 flex-shrink-0 z-50 relative no-print">
        <div class="container mx-auto px-4 h-full flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="Selecionatuforma.html" class="flex items-center gap-2 text-gray-300 hover:text-white transition">
                    <i class="fa-solid fa-arrow-left"></i> <span class="hidden sm:inline">Volver</span>
                </a>
                <a href="biblioteca-de-plantillas.html" class="bg-purple-600/20 border border-purple-500 text-purple-300 px-3 py-1 rounded-full text-xs font-bold hover:bg-purple-600 hover:text-white transition flex items-center gap-2">
                    <i class="fa-solid fa-swatchbook"></i> Biblioteca de Plantillas
                </a>
            </div>
            
            <div class="flex items-center gap-2 hidden md:flex">
                <span class="font-heading font-bold text-lg">CREADOR DE CV</span>
                <span class="text-xs text-gray-500 bg-gray-800 px-2 py-1 rounded">CV Studio33</span>
            </div>

            <div class="flex gap-3">
                <button onclick="downloadPDFDirect()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-sm transition flex items-center gap-2 shadow-lg shadow-green-900/50">
                    <i class="fa-solid fa-file-pdf"></i> <span class="hidden sm:inline">Descargar PDF</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden relative">
        
        <div class="w-full md:w-1/2 lg:w-5/12 editor-panel p-6 pb-32 no-print custom-scrollbar">
            
            <div class="mb-6 border-2 border-green-500/50 rounded-lg overflow-hidden bg-green-900/10">
                <div class="accordion-header bg-green-900/30 p-4 flex justify-between items-center" onclick="toggleAccordion('acc-axon')">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-brain text-green-400 animate-pulse"></i>
                        <div>
                            <h3 class="font-bold text-sm uppercase text-green-400">AXON PLUGIN</h3>
                            <span class="text-[10px] text-green-300/70 block leading-none">Potenciado por AXON AI</span>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-down text-xs text-green-300"></i>
                </div>
                <div id="acc-axon" class="accordion-content p-4">
                    <div class="flex justify-between items-center mb-3 border-b border-green-500/20 pb-2">
                         <label class="text-[10px] text-green-400 font-bold uppercase">Agente Activo:</label>
                         <select id="axon-agent-selector" class="bg-green-900/30 border border-green-500/30 text-green-300 text-[10px] rounded px-2 py-1 outline-none focus:border-green-400" onchange="window.changeAxonAgent()">
                             <option value="key">AXON V.1 (Default)</option>
                             <option value="key2">AXON V.2</option>
                             <option value="key3">AXON V.3</option>
                             <option value="key4">AXON V.4</option>
                             <option value="key5">AXON V.5</option>
                         </select>
                    </div>

                    <p class="text-xs text-gray-300 mb-3 text-justify">
                        <strong>AXON</strong> es tu asistente inteligente. Selecciona un agente y optimiza tu CV. Si un agente falla, cambia a la siguiente versión.
                    </p>
                    
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button onclick="window.triggerAxon('profile')" class="axon-btn px-2 py-2 rounded text-xs font-bold flex items-center justify-center gap-2">
                            <i class="fa-solid fa-user-pen"></i> Perfil
                        </button>
                        <button onclick="window.triggerAxon('experience')" class="axon-btn px-2 py-2 rounded text-xs font-bold flex items-center justify-center gap-2">
                            <i class="fa-solid fa-briefcase"></i> Experiencia
                        </button>
                        <button onclick="window.triggerAxon('skills')" class="axon-btn px-2 py-2 rounded text-xs font-bold flex items-center justify-center gap-2">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Habilidades
                        </button>
                        <button onclick="window.triggerAxon('courses')" class="axon-btn px-2 py-2 rounded text-xs font-bold flex items-center justify-center gap-2">
                            <i class="fa-solid fa-graduation-cap"></i> Cursos
                        </button>
                    </div>
                    
                    <button onclick="window.triggerAxon('tips')" class="axon-btn w-full px-3 py-2 rounded text-xs font-bold flex items-center justify-center gap-2 mb-2 bg-yellow-500/10 text-yellow-400 border-yellow-500/50 hover:bg-yellow-500/20">
                         <i class="fa-solid fa-lightbulb"></i> CONSEJOS PARA TU CV
                    </button>

                    <div id="axon-result-container" class="hidden mt-3 pt-3 border-t border-green-500/30">
                        <label class="text-[10px] text-green-400 uppercase font-bold mb-1 block">Resultado de AXON:</label>
                        <textarea id="axon-output" class="cv-input h-32 text-xs border-green-500/30 focus:border-green-400 bg-green-900/20 text-green-100" readonly></textarea>
                        <p class="text-[9px] text-gray-400 mt-1">Copia y pega el resultado en el campo correspondiente.</p>
                    </div>
                </div>
            </div>

            <div class="mb-6 border-2 border-blue-500/50 rounded-lg overflow-hidden bg-blue-900/10">
                <div class="accordion-header bg-blue-900/30 p-4 flex justify-between items-center" onclick="toggleAccordion('acc-design')">
                    <h3 class="font-bold flex items-center gap-2 text-sm uppercase text-blue-300"><i class="fa-solid fa-paintbrush"></i> Diseño & Estilo</h3>
                    <i class="fa-solid fa-chevron-down text-xs text-blue-300"></i>
                </div>
                <div id="acc-design" class="accordion-content p-4">
                    <label class="cv-label">Fuente del Cuerpo</label>
                    <select class="cv-select mb-3" id="design-font-body" onchange="updateDesign()">
                        <option value="'Arial', sans-serif">Arial (Default)</option>
                        <option value="'Open Sans', sans-serif">Open Sans</option>
                        <option value="'Roboto', sans-serif">Roboto</option>
                        <option value="'Lato', sans-serif">Lato</option>
                        <option value="'Raleway', sans-serif">Raleway</option>
                        <option value="'Merriweather', serif">Merriweather</option>
                    </select>

                    <label class="cv-label">Fuente de Encabezados</label>
                    <select class="cv-select mb-3" id="design-font-header" onchange="updateDesign()">
                        <option value="'Arial', sans-serif">Arial (Default)</option>
                        <option value="'Montserrat', sans-serif">Montserrat</option>
                        <option value="'Oswald', sans-serif">Oswald</option>
                        <option value="'Playfair Display', serif">Playfair Display</option>
                        <option value="'Roboto Slab', serif">Roboto Slab</option>
                    </select>

                    <label class="cv-label flex justify-between">
                        <span>Dimensión de Letra</span>
                        <span class="text-xs text-gray-400" id="scale-val">100%</span>
                    </label>
                    <input type="range" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer mb-4" id="design-scale" min="0.85" max="1.15" step="0.05" value="1" oninput="updateDesign()">

                    <label class="cv-label">Paleta de Colores</label>
                    <div class="flex gap-3 mt-2 justify-start">
                        <button onclick="setPalette('#00AED6')" class="w-8 h-8 rounded-full border-2 border-white bg-[#00AED6] hover:scale-110 transition shadow-lg ring-2 ring-transparent focus:ring-blue-400" title="Azul Studio33"></button>
                        <button onclick="setPalette('#10b981')" class="w-8 h-8 rounded-full border-2 border-white bg-emerald-500 hover:scale-110 transition shadow-lg" title="Esmeralda"></button>
                        <button onclick="setPalette('#8b5cf6')" class="w-8 h-8 rounded-full border-2 border-white bg-violet-500 hover:scale-110 transition shadow-lg" title="Violeta"></button>
                        <button onclick="setPalette('#ef4444')" class="w-8 h-8 rounded-full border-2 border-white bg-red-500 hover:scale-110 transition shadow-lg" title="Rojo"></button>
                        <button onclick="setPalette('#334155')" class="w-8 h-8 rounded-full border-2 border-white bg-slate-700 hover:scale-110 transition shadow-lg" title="Oscuro"></button>
                    </div>
                </div>
            </div>

            <div class="mb-4 border border-white/10 rounded-lg overflow-hidden bg-black/20">
                <div class="accordion-header bg-white/5 p-4 flex justify-between items-center" onclick="toggleAccordion('acc-personal')">
                    <h3 class="font-bold flex items-center gap-2 text-sm uppercase"><i class="fa-solid fa-user text-blue-400"></i> Datos Personales</h3>
                    <i class="fa-solid fa-chevron-down text-xs"></i>
                </div>
                <div id="acc-personal" class="accordion-content p-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="cv-label">Nombre</label><input type="text" class="cv-input" id="input-name" placeholder="Juan" oninput="updateCV()"></div>
                        <div><label class="cv-label">Apellido</label><input type="text" class="cv-input" id="input-lastname" placeholder="Pérez" oninput="updateCV()"></div>
                    </div>
                    
                    <label class="cv-label">Foto de Perfil</label>
                    <div class="bg-black/30 p-3 rounded-lg border border-white/10">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-gray-300">Mostrar foto</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="check-photo" class="sr-only peer" checked onchange="togglePhotoDisplay(); updateCV()">
                                <div class="w-9 h-5 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <input type="file" id="input-photo" accept="image/*" class="text-xs text-gray-400 w-full file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700" onchange="previewPhoto()">
                    </div>

                    <div class="grid grid-cols-1 gap-4 mt-2">
                        <div><label class="cv-label">Email</label><input type="email" class="cv-input" id="input-email" oninput="updateCV()"></div>
                        <div><label class="cv-label">Teléfono</label><input type="tel" class="cv-input" id="input-phone" oninput="updateCV()"></div>
                        <div><label class="cv-label">Dirección Completa</label><input type="text" class="cv-input" id="input-address" placeholder="Calle, Ciudad, CP" oninput="updateCV()"></div>
                    </div>
                </div>
            </div>

            <div class="mb-4 border border-white/10 rounded-lg overflow-hidden bg-black/20">
                <div class="accordion-header bg-white/5 p-4 flex justify-between items-center" onclick="toggleAccordion('acc-profile')">
                    <h3 class="font-bold flex items-center gap-2 text-sm uppercase"><i class="fa-solid fa-align-left text-blue-400"></i> Perfil Personal</h3>
                    <i class="fa-solid fa-chevron-down text-xs"></i>
                </div>
                <div id="acc-profile" class="accordion-content p-4">
                    <textarea class="cv-input h-40" id="input-profile" maxlength="1000" placeholder="Escribe aquí tu resumen profesional..." oninput="updateCV()"></textarea>
                    <p class="warning-text">Para evitar que su texto se salga de la hoja, Considere tocar ENTER para cambiar de línea.</p>
                </div>
            </div>

            <div class="mb-4 border border-white/10 rounded-lg overflow-hidden bg-black/20">
                <div class="accordion-header bg-white/5 p-4 flex justify-between items-center" onclick="toggleAccordion('acc-exp')">
                    <h3 class="font-bold flex items-center gap-2 text-sm uppercase"><i class="fa-solid fa-briefcase text-blue-400"></i> Experiencia Laboral</h3>
                    <i class="fa-solid fa-plus text-xs"></i>
                </div>
                <div id="acc-exp" class="accordion-content p-4">
                    <div id="experience-container"></div>
                    <button class="w-full py-2 bg-blue-600/30 border border-blue-500/50 text-blue-300 rounded hover:bg-blue-600/50 transition mt-3 text-sm font-bold" onclick="addExperience()">
                        <i class="fa-solid fa-plus"></i> Agregar Empleo
                    </button>
                </div>
            </div>

            <div class="mb-4 border border-white/10 rounded-lg overflow-hidden bg-black/20">
                <div class="accordion-header bg-white/5 p-4 flex justify-between items-center" onclick="toggleAccordion('acc-edu')">
                    <h3 class="font-bold flex items-center gap-2 text-sm uppercase"><i class="fa-solid fa-graduation-cap text-blue-400"></i> Educación</h3>
                    <i class="fa-solid fa-plus text-xs"></i>
                </div>
                <div id="acc-edu" class="accordion-content p-4">
                    <div id="education-container"></div>
                    <button class="w-full py-2 bg-blue-600/30 border border-blue-500/50 text-blue-300 rounded hover:bg-blue-600/50 transition mt-3 text-sm font-bold" onclick="addEducation()">
                        <i class="fa-solid fa-plus"></i> Agregar Educación
                    </button>
                </div>
            </div>

            <div class="mb-4 border border-white/10 rounded-lg overflow-hidden bg-black/20">
                <div class="accordion-header bg-white/5 p-4 flex justify-between items-center" onclick="toggleAccordion('acc-skills')">
                    <h3 class="font-bold flex items-center gap-2 text-sm uppercase"><i class="fa-solid fa-sliders text-blue-400"></i> Áreas de Especialidad</h3>
                    <i class="fa-solid fa-plus text-xs"></i>
                </div>
                <div id="acc-skills" class="accordion-content p-4">
                    <div id="skills-container" class="space-y-2"></div>
                    <button class="w-full py-2 bg-blue-600/30 border border-blue-500/50 text-blue-300 rounded hover:bg-blue-600/50 transition mt-3 text-sm font-bold" onclick="addSkill()">
                        <i class="fa-solid fa-plus"></i> Agregar Habilidad
                    </button>
                </div>
            </div>

             <div class="mb-4 border border-white/10 rounded-lg overflow-hidden bg-black/20">
                <div class="accordion-header bg-white/5 p-4 flex justify-between items-center" onclick="toggleAccordion('acc-courses')">
                    <h3 class="font-bold flex items-center gap-2 text-sm uppercase"><i class="fa-solid fa-certificate text-blue-400"></i> Entrenamiento Profesional</h3>
                    <i class="fa-solid fa-plus text-xs"></i>
                </div>
                <div id="acc-courses" class="accordion-content p-4">
                    <div id="courses-container"></div>
                    <button class="w-full py-2 bg-blue-600/30 border border-blue-500/50 text-blue-300 rounded hover:bg-blue-600/50 transition mt-3 text-sm font-bold" onclick="addCourse()">
                        <i class="fa-solid fa-plus"></i> Agregar Curso
                    </button>
                </div>
            </div>

            <div class="mb-4 border border-white/10 rounded-lg overflow-hidden bg-black/20">
                <div class="accordion-header bg-white/5 p-4 flex justify-between items-center" onclick="toggleAccordion('acc-custom')">
                    <h3 class="font-bold flex items-center gap-2 text-sm uppercase"><i class="fa-solid fa-star text-blue-400"></i> Sección Personalizada</h3>
                    <i class="fa-solid fa-plus text-xs"></i>
                </div>
                <div id="acc-custom" class="accordion-content p-4">
                    <div id="custom-sections-wrapper"></div>
                    <button class="w-full py-2 bg-slate-700 text-gray-300 rounded hover:bg-slate-600 transition mt-4 text-xs font-bold border border-slate-600" onclick="addCustomSectionBlock()">
                        <i class="fa-solid fa-plus"></i> Agregar Sección Personalizada (Max 2)
                    </button>
                </div>
            </div>

        </div>

        <div class="hidden md:flex w-1/2 lg:w-7/12 bg-gray-800 justify-center overflow-y-auto relative no-print p-8 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
            <div class="scale-90 origin-top transition-transform duration-300" id="preview-wrapper"> 
                
                <div id="cv-preview" class="a4-page shadow-2xl">
                    <div style="width: 100%;">
                        
                        <header>
                            <div class="profile-photo" id="display-photo"></div>
                            <h1 class="cv-header-title">Curriculum Vitae</h1>
                        </header>

                        <div class="section">
                            <h2 class="section-title">Detalles personales</h2>
                            <hr>
                            <div class="details-grid">
                                <span class="label">Nombre</span>
                                <span class="value" id="display-fullname">Juan Pérez</span>

                                <span class="label">Número telefónico</span>
                                <span class="value" id="display-phone">+34 000 000 000</span>

                                <span class="label">Correo electrónico</span>
                                <span class="value" id="display-email">ejemplo@email.com</span>
                                
                                <span class="label">Dirección</span>
                                <span class="value" id="display-address">Calle Ejemplo, Ciudad</span>
                            </div>
                        </div>

                        <div class="section">
                            <h2 class="section-title">Perfil</h2>
                            <hr>
                            <p id="display-profile">
                                Aquí aparecerá tu resumen profesional.
                            </p>
                        </div>

                        <div class="section">
                            <h2 class="section-title">Experiencia Laboral</h2>
                            <hr>
                            <div id="display-experience"></div>
                        </div>

                        <div class="section">
                            <h2 class="section-title">Educación</h2>
                            <hr>
                            <div id="display-education"></div>
                        </div>
                        
                        <div class="section" id="section-skills-container">
                            <h2 class="section-title">Áreas de especialidad</h2>
                            <hr>
                            <ul class="std-list" id="display-skills"></ul>
                        </div>

                        <div class="section" id="section-courses-container">
                            <h2 class="section-title">Entrenamiento Profesional</h2>
                            <hr>
                            <div id="display-courses"></div>
                        </div>

                        <div id="display-custom-sections-container"></div>

                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="fixed bottom-6 right-6 md:hidden z-50 no-print">
        <button onclick="toggleMobileModal()" class="bg-blue-600 hover:bg-blue-500 text-white rounded-full p-4 shadow-2xl animate-bounce">
            <i class="fa-solid fa-eye text-xl"></i>
        </button>
    </div>

    <div id="mobile-modal" class="mobile-preview-modal no-print">
        <div class="p-4">
            <button onclick="toggleMobileModal()" class="fixed top-4 right-4 bg-red-600 text-white p-2 rounded-full z-50 shadow-lg">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <div class="flex justify-center min-h-screen pt-12 pb-20">
                <div id="mobile-cv-clone-container" class="origin-top scale-[0.45] sm:scale-75 shadow-2xl"></div>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABLES GLOBALES ---
        let experienceCount = 0;
        let educationCount = 0;
        let skillCount = 0;
        let courseCount = 0;
        let customSectionsCount = 0;
        const maxExp = 6;
        const maxEdu = 4;
        const maxCustom = 2;

        // --- INICIALIZACIÓN ---
        window.onload = function() {
            // Inicializar inputs vacíos
            addExperience();
            addEducation();
            addSkill();
            addCourse();
            
            // Cargar datos
            loadData();
            
            // Render
            updateCV();
            updateDesign(); // Aplicar diseño inicial

            // Init Sortables (Drag & Drop)
            initSortables();
        };

        function initSortables() {
            const commonOptions = {
                animation: 150,
                ghostClass: 'sortable-ghost',
                delay: 200,
                delayOnTouchOnly: true,
                draggable: '.draggable-item'
            };
            
            // Reordenamiento Interno (Listas)
            const internalOptions = { ...commonOptions, draggable: '> div' }; 
            const listOptions = { ...commonOptions, draggable: '> li' };

            new Sortable(document.getElementById('display-experience'), internalOptions);
            new Sortable(document.getElementById('display-education'), internalOptions);
            new Sortable(document.getElementById('display-skills'), listOptions);
            new Sortable(document.getElementById('display-courses'), internalOptions);
        }

        // --- GESTIÓN DE DATOS ---
        function saveData() {
            const data = {
                name: val('input-name'),
                lastname: val('input-lastname'),
                email: val('input-email'),
                phone: val('input-phone'),
                address: val('input-address'),
                profile: val('input-profile'),
                showPhoto: document.getElementById('check-photo').checked,
                // Guardar Diseño
                designBody: val('design-font-body'),
                designHeader: val('design-font-header'),
                designScale: val('design-scale'),
                // El color se guarda en una variable global o hidden, aquí lo simulamos
                designColor: document.documentElement.style.getPropertyValue('--cv-primary')
            };
            localStorage.setItem('cvDataSergio', JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem('cvDataSergio');
            if(saved) {
                const data = JSON.parse(saved);
                if(data.name) document.getElementById('input-name').value = data.name;
                if(data.lastname) document.getElementById('input-lastname').value = data.lastname;
                if(data.email) document.getElementById('input-email').value = data.email;
                if(data.phone) document.getElementById('input-phone').value = data.phone;
                if(data.address) document.getElementById('input-address').value = data.address;
                if(data.profile) document.getElementById('input-profile').value = data.profile;
                if(data.showPhoto !== undefined) document.getElementById('check-photo').checked = data.showPhoto;
                
                // Cargar Diseño
                if(data.designBody) document.getElementById('design-font-body').value = data.designBody;
                if(data.designHeader) document.getElementById('design-font-header').value = data.designHeader;
                if(data.designScale) document.getElementById('design-scale').value = data.designScale;
                if(data.designColor) setPalette(data.designColor);
            }
        }

        // --- DISEÑO ---
        function setPalette(color) {
            document.documentElement.style.setProperty('--cv-primary', color);
            saveData();
        }

        function updateDesign() {
            const bodyFont = val('design-font-body');
            const headerFont = val('design-font-header');
            const scale = val('design-scale');

            document.documentElement.style.setProperty('--cv-body-font', bodyFont);
            document.documentElement.style.setProperty('--cv-header-font', headerFont);
            document.documentElement.style.setProperty('--cv-scale', scale);
            
            document.getElementById('scale-val').innerText = Math.round(scale * 100) + '%';
            
            saveData();
        }

        // --- LÓGICA DE ACTUALIZACIÓN ---
        function updateCV() {
            saveData(); 

            const name = val('input-name') || 'Juan';
            const lastname = val('input-lastname') || 'Pérez';
            const fullName = `${name} ${lastname}`;
            
            // Map Name to Detail Grid
            txt('display-fullname', fullName);
            
            txt('display-email', val('input-email') || 'ejemplo@cvstudio33.com'); 
            txt('display-phone', val('input-phone') || '+34 000 000 000');
            txt('display-address', val('input-address') || 'Calle Ejemplo, Ciudad');

            txt('display-profile', val('input-profile') || 'Aquí aparecerá tu resumen profesional.');
            
            togglePhotoDisplay();

            renderExperience();
            renderEducation();
            renderSkills();
            renderCourses();
            renderCustomSections();
        }

        function val(id) { return document.getElementById(id) ? document.getElementById(id).value : ''; }
        function txt(id, text) { if(document.getElementById(id)) document.getElementById(id).innerText = text; }
        
        function previewPhoto() {
            const file = document.getElementById('input-photo').files[0];
            const reader = new FileReader();
            reader.onloadend = function () { 
                document.getElementById('display-photo').style.backgroundImage = `url('${reader.result}')`; 
            }
            if (file) reader.readAsDataURL(file);
        }
        
        function togglePhotoDisplay() {
            const el = document.getElementById('display-photo');
            const isChecked = document.getElementById('check-photo').checked;
            el.style.display = isChecked ? 'block' : 'none';
        }

        function toggleAccordion(id) {
            document.getElementById(id).classList.toggle('active');
        }

        // --- RENDERIZADO DINÁMICO (ADAPTADO A PLANTILLA SERGIO MORÁN) ---

        function addExperience() {
            if (experienceCount >= maxExp) return;
            experienceCount++;
            const id = experienceCount;
            const html = `
                <div class="bg-white/5 p-3 rounded mb-3 border border-white/10" id="exp-form-${id}">
                    <div class="flex justify-between mb-2"><span class="text-xs font-bold text-blue-300">Exp ${id}</span><button class="text-red-400 text-xs" onclick="removeEl('exp-form-${id}'); updateCV()"><i class="fa-solid fa-trash"></i></button></div>
                    <input type="text" class="cv-input mb-2" id="exp-role-${id}" placeholder="Puesto" oninput="updateCV()">
                    <input type="text" class="cv-input mb-2" id="exp-comp-${id}" placeholder="Compañía" oninput="updateCV()">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div><label class="text-[10px] text-gray-400">Inicio (Año/Mes)</label><input type="text" class="cv-input text-xs" id="exp-start-${id}" placeholder="ene. 2018" oninput="updateCV()"></div>
                        <div><label class="text-[10px] text-gray-400">Fin (Año/Mes)</label><input type="text" class="cv-input text-xs" id="exp-end-${id}" placeholder="Presente" oninput="updateCV()"></div>
                    </div>
                    <textarea class="cv-input h-20 text-xs" id="exp-desc-${id}" placeholder="Descripción de responsabilidades..." oninput="updateCV()"></textarea>
                </div>`;
            document.getElementById('experience-container').insertAdjacentHTML('beforeend', html);
        }

        function renderExperience() {
            let html = '';
            for(let i=1; i<=experienceCount; i++) {
                if(!document.getElementById(`exp-role-${i}`)) continue;
                const role = val(`exp-role-${i}`);
                const comp = val(`exp-comp-${i}`);
                const start = val(`exp-start-${i}`);
                const end = val(`exp-end-${i}`);
                const desc = val(`exp-desc-${i}`);

                if(role || comp) {
                    html += `
                    <div class="timeline-item draggable-item">
                        <div class="time-col">${start} - ${end}</div>
                        <div class="separator-col">
                            <div class="dot"></div>
                            <div class="line"></div>
                        </div>
                        <div class="content-col">
                            <span class="job-title">${role}</span>
                            <span class="company">${comp}</span>
                            <div class="job-desc">${desc}</div>
                        </div>
                    </div>`;
                }
            }
            document.getElementById('display-experience').innerHTML = html;
        }

        function addEducation() {
            if (educationCount >= maxEdu) return;
            educationCount++;
            const id = educationCount;
            const html = `
                <div class="bg-white/5 p-3 rounded mb-3 border border-white/10" id="edu-form-${id}">
                    <div class="flex justify-between mb-2"><span class="text-xs font-bold text-blue-300">Edu ${id}</span><button class="text-red-400 text-xs" onclick="removeEl('edu-form-${id}'); updateCV()"><i class="fa-solid fa-trash"></i></button></div>
                    <input type="text" class="cv-input mb-2" id="edu-degree-${id}" placeholder="Título (Ej: Licenciatura...)" oninput="updateCV()">
                    <input type="text" class="cv-input mb-2" id="edu-inst-${id}" placeholder="Institución" oninput="updateCV()">
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-[10px] text-gray-400">Inicio</label><input type="text" class="cv-input text-xs" id="edu-start-${id}" placeholder="2010" oninput="updateCV()"></div>
                        <div><label class="text-[10px] text-gray-400">Fin</label><input type="text" class="cv-input text-xs" id="edu-end-${id}" placeholder="2014" oninput="updateCV()"></div>
                    </div>
                </div>`;
            document.getElementById('education-container').insertAdjacentHTML('beforeend', html);
        }

        function renderEducation() {
            let html = '';
            for(let i=1; i<=educationCount; i++) {
                if(!document.getElementById(`edu-degree-${i}`)) continue;
                const degree = val(`edu-degree-${i}`);
                const inst = val(`edu-inst-${i}`);
                const start = val(`edu-start-${i}`);
                const end = val(`edu-end-${i}`);
                
                if(degree || inst) {
                    html += `
                    <div class="timeline-item draggable-item">
                        <div class="time-col">${start} - ${end}</div>
                        <div class="separator-col">
                            <div class="line" style="top: -20px; height: 25px;"></div>
                            <div class="arrow-down"></div>
                        </div>
                        <div class="content-col">
                            <span class="job-title">${degree}</span>
                            <span class="company">${inst}</span>
                        </div>
                    </div>`;
                }
            }
            document.getElementById('display-education').innerHTML = html;
        }

        function addSkill() { 
            skillCount++; 
            const id = skillCount; 
            const html = `
            <div class="bg-white/5 p-2 rounded mb-2 border border-white/10" id="skill-form-${id}">
                <div class="flex gap-2 items-center mb-1">
                    <input type="text" class="cv-input" id="skill-name-${id}" placeholder="Habilidad" oninput="updateCV()">
                    <button class="text-red-400" onclick="removeEl('skill-form-${id}'); updateCV()"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="flex items-center gap-2 hidden">
                    <span class="text-[10px] text-gray-400">Nivel:</span>
                    <input type="range" id="skill-level-${id}" min="1" max="5" value="4" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer" oninput="updateCV()">
                </div>
            </div>`; 
            document.getElementById('skills-container').insertAdjacentHTML('beforeend', html); 
        }

        function renderSkills() { 
            let html = ''; 
            for(let i=1; i<=skillCount; i++) { 
                if(!document.getElementById(`skill-name-${i}`)) continue; 
                const name = val(`skill-name-${i}`); 
                if(name) {
                    html += `<li>${name}</li>`; 
                }
            } 
            document.getElementById('display-skills').innerHTML = html; 
            document.getElementById('section-skills-container').style.display = html ? 'block' : 'none';
        }

        function addCourse() {
            courseCount++;
            const id = courseCount;
            const html = `
                <div class="bg-white/5 p-2 rounded mb-2 border border-white/10" id="course-form-${id}">
                    <div class="flex justify-between"><span class="text-[10px] text-purple-300">Curso</span><button class="text-red-400 text-xs" onclick="removeEl('course-form-${id}'); updateCV()"><i class="fa-solid fa-xmark"></i></button></div>
                    <input type="text" class="cv-input mb-1 text-xs" id="course-title-${id}" placeholder="Nombre del Curso" oninput="updateCV()">
                    <input type="text" class="cv-input mb-1 text-xs" id="course-issuer-${id}" placeholder="Institución, Año" oninput="updateCV()">
                    <label class="text-[10px] text-gray-400 mt-1 block">Descripción</label>
                    <textarea class="cv-input h-16 text-xs mb-1" id="course-desc-${id}" placeholder="Detalles del curso..." oninput="updateCV()"></textarea>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-[10px] text-gray-400">Espaciado:</span>
                        <input type="range" id="course-spacing-${id}" min="0" max="20" value="5" class="w-full h-1 bg-gray-600 rounded-lg" oninput="updateCV()">
                    </div>
                </div>`;
            document.getElementById('courses-container').insertAdjacentHTML('beforeend', html);
        }

        function renderCourses() {
            let html = '';
            for(let i=1; i<=courseCount; i++) {
                if(!document.getElementById(`course-title-${i}`)) continue;
                const title = val(`course-title-${i}`);
                const issuer = val(`course-issuer-${i}`);
                const desc = val(`course-desc-${i}`);
                const spacing = val(`course-spacing-${i}`);

                if(title) {
                    html += `
                    <div class="timeline-item draggable-item" style="margin-bottom: ${parseInt(spacing) + 10}px;">
                         <div class="time-col"></div> <div class="separator-col">
                            <div class="dot" style="width: 6px; height: 6px; background-color: #666;"></div>
                         </div>
                         <div class="content-col">
                            <span class="job-title" style="font-size: 9.5pt;">${title}</span>
                            <span class="company">${issuer}</span>
                            ${desc ? `<p class="job-desc">${desc}</p>` : ''}
                        </div>
                    </div>`;
                }
            }
            document.getElementById('display-courses').innerHTML = html;
            document.getElementById('section-courses-container').style.display = html ? 'block' : 'none';
        }

        // --- SECCIÓN PERSONALIZADA ---
        function addCustomSectionBlock() {
            if (customSectionsCount >= maxCustom) return;
            customSectionsCount++;
            const id = customSectionsCount;
            const html = `
                <div class="mt-4 pt-4 border-t-2 border-blue-500/30" id="custom-block-${id}">
                    <div class="flex justify-between"><p class="text-xs text-blue-400 font-bold mb-3 uppercase flex items-center gap-2"><i class="fa-solid fa-pen-to-square"></i> Custom #${id}</p><button class="text-red-400 text-xs" onclick="removeEl('custom-block-${id}'); updateCV()"><i class="fa-solid fa-trash"></i></button></div>
                    <input type="text" class="cv-input mb-2" id="cust-title-${id}" placeholder="Título de la Sección" oninput="updateCV()">
                    <textarea class="cv-input h-24" id="cust-content-${id}" placeholder="Contenido (Texto libre)..." oninput="updateCV()"></textarea>
                </div>`;
            document.getElementById('custom-sections-wrapper').insertAdjacentHTML('beforeend', html);
        }

        function renderCustomSections() {
            let html = '';
            for(let i=1; i<=customSectionsCount; i++) {
                if(!document.getElementById(`custom-block-${i}`)) continue;
                const title = val(`cust-title-${i}`);
                const content = val(`cust-content-${i}`);

                if(title || content) {
                     html += `
                    <div class="section draggable-item">
                         ${title ? `<h2 class="section-title">${title}</h2><hr>` : ''}
                        <p>${content.replace(/\n/g, '<br>')}</p>
                    </div>`;
                }
            }
            document.getElementById('display-custom-sections-container').innerHTML = html;
        }

        function removeEl(id) { document.getElementById(id).remove(); updateCV(); }

        function downloadPDFDirect() {
            const element = document.getElementById('cv-preview');
            const opt = {
                margin:       0,
                filename:     'cv-studio33-profesional.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function toggleMobileModal() {
            const modal = document.getElementById('mobile-modal');
            const container = document.getElementById('mobile-cv-clone-container');
            const originalCV = document.getElementById('cv-preview');
            if (modal.classList.contains('active')) { modal.classList.remove('active'); container.innerHTML = ''; } 
            else { modal.classList.add('active'); const clone = originalCV.cloneNode(true); clone.style.margin = '0'; clone.style.transform = 'scale(1)'; container.appendChild(clone); }
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDbPAgKs2_L4NTafhyDUW0Ui_U5aRL5728",
          authDomain: "cv-studio33.firebaseapp.com",
          projectId: "cv-studio33",
          storageBucket: "cv-studio33.firebasestorage.app",
          messagingSenderId: "189453088234",
          appId: "1:189453088234:web:639c130a6287ff34122e93"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let axonConfigData = null;
        let currentKeyField = 'key'; // Default to V1

        // Obtener Configuración Completa Asíncronamente
        async function fetchAxonConfig() {
            try {
                const docRef = doc(db, "config", "ID33");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    axonConfigData = docSnap.data();
                    console.log("AXON: Sistema listo. Agentes cargados.");
                } else {
                    console.error("AXON Error: Configuración no encontrada.");
                }
            } catch (error) {
                console.error("AXON Error de conexión:", error);
            }
        }
        
        fetchAxonConfig();

        // Función para cambiar de Agente
        window.changeAxonAgent = function() {
            const selector = document.getElementById('axon-agent-selector');
            currentKeyField = selector.value;
            console.log("AXON: Cambiado a " + currentKeyField);
        };

        // Expone la función a la ventana global
        window.triggerAxon = async function(mode) {
            if (!axonConfigData) {
                alert("AXON se está inicializando, intenta de nuevo en unos segundos.");
                return;
            }

            const apiKey = axonConfigData[currentKeyField];
            
            if(!apiKey) {
                 alert(`Error: El Agente seleccionado (${currentKeyField}) no tiene una clave configurada.`);
                 return;
            }

            const output = document.getElementById('axon-output');
            const container = document.getElementById('axon-result-container');
            const buttons = document.querySelectorAll('.axon-btn');
            
            // UI Loading
            container.classList.remove('hidden');
            output.value = "AXON está analizando tus datos...";
            buttons.forEach(b => b.classList.add('axon-loading'));

            let promptContext = "";
            let promptInstruction = "";

            // Recopilar datos según el modo
            if (mode === 'profile') {
                const profile = document.getElementById('input-profile').value;
                if(!profile) { alert("Escribe algo en el perfil primero."); buttons.forEach(b => b.classList.remove('axon-loading')); return; }
                promptContext = `Perfil Actual: "${profile}"`;
                promptInstruction = "Reescribe este perfil profesional para que sea más impactante, use palabras clave de liderazgo y logros, y sea atractivo para reclutadores. No uses comillas ni asteriscos en la respuesta.";
            } 
            else if (mode === 'experience') {
                let expText = "";
                const titles = document.querySelectorAll('[id^="exp-role-"]');
                titles.forEach(el => {
                    const id = el.id.split('-')[2];
                    const comp = document.getElementById(`exp-comp-${id}`).value;
                    const desc = document.getElementById(`exp-desc-${id}`).value;
                    expText += `Puesto: ${el.value}, Empresa: ${comp}, Descripción: ${desc}\n`;
                });
                if(!expText) { alert("Agrega al menos una experiencia."); buttons.forEach(b => b.classList.remove('axon-loading')); return; }
                promptContext = `Experiencia Laboral:\n${expText}`;
                promptInstruction = "Mejora la redacción de estas experiencias laborales. Usa verbos de acción, enfócate en logros cuantificables y mejora la estructura para un CV ejecutivo. No uses comillas ni asteriscos.";
            }
            else if (mode === 'skills') {
                let skillsText = "";
                const skills = document.querySelectorAll('[id^="skill-name-"]');
                skills.forEach(el => skillsText += `- ${el.value}\n`);
                if(!skillsText) { alert("Agrega habilidades primero."); buttons.forEach(b => b.classList.remove('axon-loading')); return; }
                promptContext = `Habilidades actuales:\n${skillsText}`;
                promptInstruction = "Para cada habilidad listada, reemplázala por un término profesional de alto impacto (ej: 'Trabajo en equipo' -> 'Liderazgo Colaborativo'). Devuelve ÚNICAMENTE la lista de términos mejorados, uno por línea, sin viñetas, sin comillas y sin explicaciones.";
            }
            else if (mode === 'courses') {
                let courseText = "";
                const courses = document.querySelectorAll('[id^="course-desc-"]');
                courses.forEach(el => {
                    const id = el.id.split('-')[2];
                    const title = document.getElementById(`course-title-${id}`).value;
                    courseText += `Curso: ${title}, Detalle: ${el.value}\n`;
                });
                if(!courseText) { alert("Agrega descripción a tus cursos primero."); buttons.forEach(b => b.classList.remove('axon-loading')); return; }
                promptContext = `Cursos:\n${courseText}`;
                promptInstruction = "Mejora la descripción de estos cursos para que suenen más prestigiosos, enfocados en el valor profesional y habilidades adquiridas. Sé conciso. No uses comillas ni asteriscos.";
            }
            else if (mode === 'tips') {
                 // Recopilar TODO
                 const profile = document.getElementById('input-profile').value;
                 let expText = "";
                 document.querySelectorAll('[id^="exp-role-"]').forEach(el => {
                    const id = el.id.split('-')[2];
                    expText += `${el.value} en ${document.getElementById(`exp-comp-${id}`).value}: ${document.getElementById(`exp-desc-${id}`).value}\n`;
                 });
                 let skillsText = "";
                 document.querySelectorAll('[id^="skill-name-"]').forEach(el => skillsText += `${el.value}, `);
                 
                 promptContext = `PERFIL: ${profile}\nEXPERIENCIA: ${expText}\nHABILIDADES: ${skillsText}`;
                 promptInstruction = "Analiza críticamente este CV. No reescribas nada. Dame una lista de 3 a 5 consejos estratégicos, directos y duros sobre qué cambiar, qué agregar o qué eliminar para maximizar el impacto y pasar filtros ATS. Sé breve.";
            }

            // Construcción del Prompt System
            const finalPrompt = {
                contents: [{
                    parts: [{
                        text: `Eres AXON, una IA avanzada de optimización de carreras integrada en CV Studio33. Tu tono es profesional, persuasivo y orientado a resultados (ATS friendly). Tu misión es reescribir y potenciar el contenido del usuario.
                        
                        ${promptInstruction}
                        
                        DATOS DEL USUARIO:
                        ${promptContext}
                        
                        Respuesta (Texto limpio, sin comillas, sin markdown):`
                    }]
                }]
            };

            try {
                // LLAMADA API GEMINI (MODELO ESPECÍFICO)
                const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(finalPrompt)
                });

                if (!response.ok) {
                    // Manejo de Error Personalizado AXON
                    if(response.status === 400 || response.status === 429 || response.status === 403) {
                         throw new Error("AXON_QUOTA_EXCEEDED");
                    }
                    throw new Error(`Error API: ${response.status}`);
                }

                const data = await response.json();
                let aiText = data.candidates[0].content.parts[0].text;
                
                // LIMPIEZA DE FORMATO
                let cleanText = aiText.replace(/[\"*]/g, '');
                
                output.value = cleanText.trim();

            } catch (error) {
                console.error(error);
                if (error.message === "AXON_QUOTA_EXCEEDED") {
                     output.value = `AXON: Mis recursos de energía se han agotado en este canal. Por favor, cambia al siguiente Agente (ej: AXON V.2) en el selector superior para continuar.`;
                } else {
                     output.value = "Error al conectar con AXON. Intenta nuevamente.";
                }
            } finally {
                buttons.forEach(b => b.classList.remove('axon-loading'));
            }
        };
    </script>
</body>
</html>